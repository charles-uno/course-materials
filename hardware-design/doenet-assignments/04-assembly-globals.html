
<section>
    <title>Reading for Next Class</title>

    <p>Read Sections 1.1 through 1.3 from <ref uri="https://diveintosystems.org/book/index.html">Dive Into Systems</ref>. Take notes as you read through
        these
        sections. After completing the reading, write a summary below. This summary will be graded manually.</p>

    <answer>
        <textInput name="summary" expanded />
        <award>
            <when>
                <text>$summary</text> != <text></text>
            </when>
        </award>
    </answer>

</section>



<setup>
    <module name="memSlots" newNamespace>
        <setup>
          <customAttribute componentType="text" assignNames="arrayName" attribute="arrayName" defaultValue=""/>
          <customAttribute componentType="number" assignNames="size" attribute="size" defaultValue=""/>
          <customAttribute componentType="textList" assignNames="items" attribute="items" defaultValue=""/>
          <customAttribute componentType="textList" assignNames="labels" attribute="labels" defaultValue=""/>
          <customAttribute componentType="boolean" assignNames="inGraph" attribute="inGraph" defaultValue="false"/>
          <customAttribute componentType="point" assignNames="anchor" attribute="anchor" defaultValue="(0,0)"/>
        </setup>
        <conditionalContent>
          <case condition="not $inGraph">
            [$items]
          </case>
          <case condition="$inGraph">
            <text anchor="($anchor.x, $anchor.y+.5)" positionFromAnchor="right" draggable="false" >$arrayName</text>
            <map>
              <template>
                <textInput anchor="($anchor.x, $anchor.y-$i-.5)" height="32px" width="80px" positionFromAnchor="right" draggable="false">$items.texts[$i+1]</textInput>
                <text anchor="($anchor.x, $anchor.y-$i-.5)" positionFromAnchor="left" draggable="false">$labels.texts[$i+1]</text>
              </template>
              <sources alias="i">
                <sequence from="0" to="$size-1" step="1"/>
              </sources>
            </map>
            <text anchor="($anchor.x, $anchor.y-$size-.5)"><ellipsis/></text>
          </case>
        </conditionalContent>
      </module>
    </setup>
    
    <section newNamespace><title>Assembly Commands</title>
    
      <p>From the options below, select the correct syntax for storing the value 1 in register 0.</p>
    
      <answer>
          <choiceInput>
            <choice><c>mov 1, r0</c></choice>
            <choice><c>mv r0, 1</c></choice>
            <choice><c>mv 1, r0</c></choice>
            <choice credit="1"><c>mov r0, #1</c></choice>
          </choiceInput>
      </answer>
    
      <p>From the options below, select the correct syntax for copying the value from register 2 to register 1</p>
    
      <answer>
          <choiceInput>
            <choice credit="1"><c>mov r1, r2</c></choice>
            <choice><c>mov r2, r1</c></choice>
            <choice><c>cp r1, r2</c></choice>
            <choice><c>cp r2, r1</c></choice>
          </choiceInput>
      </answer>
    
      <p>From the options below, select the correct syntax for adding the values in registers 0 and 1, and storing the result in register 2</p>
    
      <answer>
          <choiceInput>
            <choice><c>mov r2, r0+r1</c></choice>
            <choice><c>add r0, r1, r2</c></choice>
            <choice credit="1"><c>add r2, r1, r0</c></choice>
            <choice><c>str r0+r1, r2</c></choice>
          </choiceInput>
      </answer>
    
      <p>From the options below, select the correct syntax for incrementing the value in register 0 by 1</p>
    
      <answer>
          <choiceInput>
            <choice credit="1"><c>add r0, r0, #1</c></choice>
            <choice><c>inc r0</c></choice>
            <choice><c>r0++</c></choice>
            <choice><c>str r0++</c></choice>
          </choiceInput>
      </answer>
    
      <p>From the options below, select the correct syntax for subtracting the value in register 2 from the value in register 1, and storing the result in register 1.</p>
    
      <answer>
          <choiceInput>
            <choice><c>sub r1, r2</c></choice>
            <choice credit="1"><c>sub r1, r2, r1</c></choice>
            <choice><c>str r2, r2-r1</c></choice>
            <choice><c>str r2-r1, r2</c></choice>
          </choiceInput>
      </answer>
    
      <p>From the options below, select the correct syntax for multiplying the value in register 0 by itself, and storing the result in register 1.</p>
    
      <answer>
          <choiceInput>
            <choice><c>sqr r1, r0</c></choice>
            <choice credit="1"><c>mul r1, r0, r0</c></choice>
            <choice><c>str r1, r0*r0</c></choice>
            <choice><c>str r1, r0^2</c></choice>
          </choiceInput>
      </answer>
    </section>
    
    <section newNamespace><title>Basic Assembly Program</title>
    
      <p>Consider the following assembly program (with line numbers).</p>
    
      <pre>1:    .global _start
    2:    _start:
    3:        mov  r0, #4
    4:        mov  r1, #8
    5:        mov  r2, r0
    6:        add  r0, r0, #2
    7:        add  r1, r0, r0
    8:        add  r2, r0, r1
    9:        sub  r2, r2, #1
    10:       sub  r0, r2, r0
    11:       mov  r0, #3
    12:       mov  r1, #2
    13:       mul  r2, r0, r1
    14:       mul  r2, r2, r2</pre>
    
      <graph displayXAxis="false" displayYAxis="false" showNavigation="false" showBorder="false" aspectRatio="2/1" size="full" xmin="0" xmax="10" ymin="0" ymax="10">
    
        <module name="registers" copysource="../memSlots" arrayName="Registers" size="4" items= "00000000 00000000 00000000 00000000" labels="r0 r1 r2 r3" inGraph="true" anchor="(2,7)"/>
    
        <rectangle vertices="(1,9) (4,2)" filled fixed/>
        <text anchor="(1.5,8.5)" fixed>CPU</text>
        
      </graph>
    
      <p><alert>Note: the data in registers should always be represented as an 8-digit (32 bit) hexadecimal number (without the prefix <c>0x</c>).</alert> Feel free to use an online converter calculator as needed.</p>
    
      <p>Update the diagram above to show the state of the registers after running the program <alert>through line 5</alert>. <answer disableAfterCorrect>
      <award><when>
        $(registers/items) = <textList>00000004 00000008 00000004 00000000</textList> 
      </when></award>
    </answer></p>
    
      <p>Update the diagram above to show the state of the registers after running the program <alert>through line 8</alert>. <answer disableAfterCorrect>
      <award><when caseInsensitiveMatch>
        $(registers/items) = <textList>00000006 0000000c 00000012 00000000</textList> 
      </when></award>
    </answer></p>
    
      <p>Update the diagram above to show the state of the registers after running the program <alert>through line 10</alert>. <answer disableAfterCorrect>
      <award><when caseInsensitiveMatch>
        $(registers/items) = <textList>0000000b 0000000c 00000011 00000000</textList> 
      </when></award>
    </answer></p>
    
      <p>Update the diagram above to show the state of the registers after running the program <alert>through line 12</alert>. <answer disableAfterCorrect>
      <award><when caseInsensitiveMatch>
        $(registers/items) = <textList>00000003 00000002 00000011 00000000</textList> 
      </when></award>
    </answer></p>
    
      <p>Update the diagram above to show the state of the registers after running the program <alert>through line 14</alert>. <answer disableAfterCorrect>
      <award><when caseInsensitiveMatch>
        $(registers/items) = <textList>00000003 00000002 00000024 00000000</textList> 
      </when></award>
    </answer></p>
    
    </section>
      
    <section newNamespace><title>More Assembly Commands</title>
    
      <p>From the options below, select the correct syntax for declaring a global variable called <c>a</c>, and assigning it value 1.</p>
    
      <answer>
          <choiceInput>
            <choice><c>int a, #1</c></choice>
            <choice credit="1"><c>a: .word 1</c></choice>
            <choice><c>a: .number 1</c></choice>
            <choice><c>a: .int #1</c></choice>
          </choiceInput>
      </answer>
    
      <p>From the options below, select the correct meaning of the line <c>.section data</c></p>
    
      <answer>
          <choiceInput>
            <choice credit="1">Marking the section of global variables</choice>
            <choice>Marking the section of global constants</choice>
            <choice>Marking the section of local variables</choice>
            <choice>Marking the section of local constants</choice>
          </choiceInput>
      </answer>
    
      <p>From the options below, select the correct meaning of the line <c>.section rodata</c></p>
    
      <answer>
          <choiceInput>
            <choice>Marking the section of global variables</choice>
            <choice credit="1">Marking the section of global constants</choice>
            <choice>Marking the section of local variables</choice>
            <choice>Marking the section of local constants</choice>
          </choiceInput>
      </answer>
    
      <p>From the options below, select the correct syntax for copying address of the variable <c>a</c> into register 0.</p>
    
      <answer>
          <choiceInput>
            <choice><c>str r0, a</c></choice>
            <choice><c>str r0, =a</c></choice>
            <choice><c>ldr r0, &a</c></choice>
            <choice credit="1"><c>ldr r0, =a</c></choice>
          </choiceInput>
      </answer>
    
      <p>From the options below, select the correct syntax for finding the value in the address held by register 1, and copying that value into register 0.</p>
    
      <answer>
          <choiceInput>
            <choice><c>ldr r0, r1</c></choice>
            <choice credit="1"><c>ldr r0, [r1]</c></choice>
            <choice><c>ldr r0, &r1</c></choice>
            <choice><c>ldr r0, =r1</c></choice>
          </choiceInput>
      </answer>
    
      <p>From the options below, select the correct syntax for taking the value in register 1, and storing that value at the address held by register 0.</p>
    
      <answer>
          <choiceInput>
            <choice><c>str r0, &r1</c></choice>
            <choice><c>str r1, &r0</c></choice>
            <choice credit="1"><c>str r1, [r0]</c></choice>
            <choice><c>str [r1], r0</c></choice>
          </choiceInput>
      </answer>
      
    </section>
    
    <section newNamespace><title>Global Constants and Variables in Assembly</title>
    
      <p>Consider the following assembly program (with line numbers).</p>
    
      <pre>1:    .section	.data
    2:    x:	.word	5
    3:    y:	.word	3
    4:
    5:    .section	.rodata
    6:    one:	.word	1
    7:
    8:    .text
    9:    .global _start
    10:   _start:
    11:       ldr	r0, =x
    12:       ldr	r1, [r0]
    13:       ldr	r0, =y
    14:       ldr	r2, [r0]
    15:       add	r1, r1, r2
    16:       str	r1, [r0]
    17:       ldr	r0, =one
    18:       ldr	r1, [r0]</pre>
    
      <graph displayXAxis="false" displayYAxis="false" showNavigation="false" showBorder="false" aspectRatio="2/1" size="full" xmin="0" xmax="10" ymin="0" ymax="10">
    
        <module name="registers" copysource="../memSlots" arrayName="Registers" size="4" items= "00000000 00000000 00000000 00000000" labels="r0 r1 r2 r3" inGraph="true" anchor="(2,7)"/>
        <rectangle vertices="(1,9) (4,2)" filled fixed/>
        <text anchor="(1.5,8.5)" fixed>CPU</text>
    
        <module name="memory" copysource="../memSlots" arrayName="Main Memory" size="8" items="00000000 00000000 00000001 00000005 00000003 00000000 00000000 00000000" labels="00000020 00000024 00000028 0000002c 00000030 00000034 00000038 0000003c" inGraph="true" anchor="(7,9)"/>
        <rectangle vertices="(5.8,9.9) (9,.1)" filled fixed/>
        
      </graph>
    
      <p><alert>Note: the data in registers and memory, as well as addresses, will be represented as an 8-digit (32 bit) hexadecimal number (without the prefix 0x).</alert> Feel free to use an online converter calculator as needed.</p>
    
      <p>The diagram above shows the state of the registers and memory after the program has been compiled, and <alert>before line 11 has executed</alert>.</p> 
      
      <p>Based on the diagram, what is the address of the global variable <c>x</c>? <answer type="text">0000002c</answer></p>
      <p>Based on the diagram, what is the address of the global variable <c>y</c>? <answer type="text">00000030</answer></p>
      <p>Based on the diagram, what is the address of the global constant <c>one</c>? <answer type="text">00000028</answer></p>
    
      <p>Update the diagram above to show the state of the registers and memory after running the program <alert>through line 12</alert>. <answer disableAfterCorrect>
      <award><when>
        $(registers/items) = <textList>0000002c 00000005 00000000 00000000</textList> 
        and $(memory/items) = <textList>00000000 00000000 00000001 00000005 00000003 00000000 00000000 00000000</textList>
      </when></award>
    </answer></p>
    
      <p>Update the diagram above to show the state of the registers and memory after running the program <alert>through line 14</alert>. <answer disableAfterCorrect>
      <award><when>
        $(registers/items) = <textList>00000030 00000005 00000003 00000000</textList> 
        and $(memory/items) = <textList>00000000 00000000 00000001 00000005 00000003 00000000 00000000 00000000</textList>
      </when></award>
    </answer></p>
    
      <p>Update the diagram above to show the state of the registers and memory after running the program <alert>through line 15</alert>. <answer disableAfterCorrect>
      <award><when>
        $(registers/items) = <textList>00000030 00000008 00000003 00000000</textList> 
        and $(memory/items) = <textList>00000000 00000000 00000001 00000005 00000003 00000000 00000000 00000000</textList>
      </when></award>
    </answer></p>
    
      <p>Update the diagram above to show the state of the registers and memory after running the program <alert>through line 16</alert>. <answer disableAfterCorrect>
      <award><when>
        $(registers/items) = <textList>00000030 00000008 00000003 00000000</textList> 
        and $(memory/items) = <textList>00000000 00000000 00000001 00000005 00000008 00000000 00000000 00000000</textList>
      </when></award>
    </answer></p>
    
      <p>Update the diagram above to show the state of the registers and memory after running the program <alert>through line 18</alert>. <answer disableAfterCorrect>
      <award><when>
        $(registers/items) = <textList>00000028 00000001 00000003 00000000</textList> 
        and $(memory/items) = <textList>00000000 00000000 00000001 00000005 00000008 00000000 00000000 00000000</textList>
      </when></award>
    </answer></p>
    
    </section>
    
    <p>The ARM Tutorial <ref uri="http://computerscience.chemeketa.edu/armTutorial/index.html">here</ref> will be helpful as you work through this lab. Sections 5.5, 6.3, 6.4, and 6.5 are relevant to this lab. Because we are jumping around to different sections in the tutorial, you probably won't understand everything, and that's fine.</p>
    
    <section><title>Setup</title>
    
    <p>Log into your personal account on your Raspberry Pi, and create a subdirectory for this lab:</p>
    <pre>  cd HD
      mkdir lab13
      cd lab13</pre>
      
    </section>
    
    <section><title>Assembling a C Program</title>
    
    <p>In your <c>lab13</c> subdirectory on your Raspberry Pi, create a C program with the following command.</p>
        <pre>  code example.c</pre>
    <p>Copy the following C code into <c>example.c</c>.</p>
    
    <pre>#include &lt;stdio.h&gt;
    
    int a = 4;
    int b = 7;
    
    const int c = 12;
    
    int main() {
        printf("a is %d.\n", a);
        printf("b is %d.\n", b);
        printf("c is %d.\n", c);
        return 0;
    }</pre>
    
    <p>Save the file.</p>
    
      <p>Compile and run example.c with the following commands.</p>
        <pre>  gcc example.c -o example
      ./example</pre>
    
      <p>To produce the assembly language version of this program, enter the command:</p>
        <pre>  gcc -c -S example.c</pre>
    
    
    <p>This should produce a file <c>example.s</c> that contains assembly code for the program <c>example.c</c>. Check that it's there by entering the <c>ls</c> command.</p>
    
      <p>Open your assembly program in VSCode using the command:</p>
    <pre>  code example.s</pre>
         <p>Your assembly program should match the code below (except for the line numbers and some added indentation).</p>
    
      <pre>1:  	.arch armv6
    2:  	.eabi_attribute 28, 1
    3:  	.eabi_attribute 20, 1
    4:  	.eabi_attribute 21, 1
    5:  	.eabi_attribute 23, 3
    6:  	.eabi_attribute 24, 1
    7:  	.eabi_attribute 25, 1
    8:  	.eabi_attribute 26, 2
    9:  	.eabi_attribute 30, 6
    10:  	.eabi_attribute 34, 1
    11:  	.eabi_attribute 18, 4
    12:  	.file	"example.c"
    13:  	.text
    14:  	.global	a
    15:  	.data
    16:  	.align	2
    17:  	.type		a, %object
    18:  	.size		a, 4
    19:  a:
    20:  	.word		4
    21:  	.global	b
    22:  	.align	2
    23:  	.type		b, %object
    24:  	.size		b, 4
    25:  b:
    26:  	.word		7
    27:  	.global	c
    28:  	.section	.rodata
    29:  	.align	2
    30:  	.type		c, %object
    31:  	.size		c, 4
    32:  c:
    33:  	.word		12
    34:  	.align	2
    35:  .LC0:
    36:  	.ascii	"a is %d.\012\000"
    37:  	.align	2
    38:  .LC1:
    39:  	.ascii	"b is %d.\012\000"
    40:  	.align	2
    41:  .LC2:
    42:  	.ascii	"c is %d.\012\000"
    43:  	.text
    44:  	.align	2
    45:  	.global	main
    46:  	.arch armv6
    47:  	.syntax unified
    48:  	.arm
    49:  	.fpu vfp
    50:  	.type	main, %function
    51:  main:
    52:  	@ args = 0, pretend = 0, frame = 0
    53:  	@ frame_needed = 1, uses_anonymous_args = 0
    54:  	push	{fp, lr}
    55:  	add	fp, sp, #4
    56:  	ldr	r3, .L3
    57:  	ldr	r3, [r3]
    58:  	mov	r1, r3
    59:  	ldr	r0, .L3+4
    60:  	bl	printf
    61:  	ldr	r3, .L3+8
    62:  	ldr	r3, [r3]
    63:  	mov	r1, r3
    64:  	ldr	r0, .L3+12
    65:  	bl	printf
    66:  	mov	r3, #12
    67:  	mov	r1, r3
    68:  	ldr	r0, .L3+16
    69:  	bl	printf
    70:  	mov	r3, #0
    71:  	mov	r0, r3
    72:  	pop	{fp, pc}
    73:  .L4:
    74:  	.align	2
    75:  .L3:
    76:  	.word		a
    77:  	.word		.LC0
    78:  	.word		b
    79:  	.word		.LC1
    80:  	.word		.LC2
    81:  	.size		main, .-main
    82:  	.ident	"GCC: (Raspbian 8.3.0-6+rpi1) 8.3.0"
    83:  	.section	.note.GNU-stack,"",%progbits</pre>
    
    <p>The C program <c>example.c</c> contained the line <c>int a = 4;</c>, which declared a global int variable named <c>a</c>, and assigned it the value 4.</p>
    
    <p>In the assembly program, find the code that stores the number 4 with the identifier <c>a</c>. Enter the line number(s) for this code, separated by commas (with no spaces). <answer type="text">19,20</answer></p>
    
      <p>The C program <c>example.c</c> contained the line <c>int b = 7;</c>, which declared a global int variable named <c>b</c>, and assigned it the value 7.</p>
    
    <p>In the assembly program, find the code that stores the number 7 with the identifier <c>b</c>. Enter the line number(s) for this code, separated by commas (with no spaces). <answer type="text">25,26</answer></p>
    
      <p>The C program <c>example.c</c> contained the line <c>const int c = 12;</c>, which declared a global int constant named <c>c</c>, and assigned it the value 12.</p>
    
    <p>In the assembly program, find the code that stores the number 12 with the identifier <c>c</c>. Enter the line number(s) for this code, separated by commas (with no spaces). <answer type="text">32,33</answer></p>
    
      <p>In the assembly program, find the code that labels the section of global constants. Enter the line number(s) for this code, separated by commas (with no spaces). <answer type="text">28</answer></p>
    
      <p>Next, we'll focus on the following lines of assembly code under main.</p>
    <pre>  ldr	r3, .L3
      ldr	r3, [r3]
      mov	r1, r3
      ldr	r0, .L3+4
      bl	printf</pre>
    <p>These lines set up and make the function call to <c>printf()</c>, which produces the output we see when we execute the program. Note that the function <c>printf()</c> is not included in the assembly code in your program; it comes from the library we included.</p>
    
    <p>Let's start with the line:</p>
    <pre>	ldr	r3, .L3</pre>
    <p>Find the identifier <c>.L3</c> in the assembly program. Similar to <c>a</c> and <c>b</c>, it is used to store a value. Here, it stores the address of <c>a</c>. Enter the line in the assembly program that tells us what <c>.L3</c> stores. <answer type="text">76</answer></p>
    
      <p>The identifier <c>.L3</c> stores the address of the variables <c>a</c>. After the lines</p>
    <pre>  ldr	r3, [r3]
      mov	r1, r3</pre>
        <p>what value is stored in <c>r1</c>? <answer>4</answer></p>
    
      <p>The next line of the assembly program is:</p>
    <pre>  ldr	r0, .L3+4</pre>
    <p>Find the identifier <c>.L3</c> in the assembly program. Then, find the second <c>.word</c> after this identifier, which stores <c>.LC0</c>. The code <c>.L3+4</c> tells us to look at <c>.L3</c>, then offset by 4 bytes. Since a <c>.word</c> is 4 bytes, this means we are accessing the second <c>.word</c> after the identifier <c>.L3</c>.</p>
    
    <p>Next, find the identifier .LC0. Enter the line in the assembly program that tells us what <c>.LC0</c> stores. <answer type="text">36</answer> What is its type (instead of <c>.word</c>)? <answer type="text">.ascii</answer></p>
    
      <p>Because strings can have a wide range of lengths, we can't store them in a <c>.word</c>, which is limited to 4 bytes. We also can't load a string directly into a register for the same reason. Instead, we need to use a pointer to the string. This means that we store the address of the string, and then we can load that address into a register to call a function on that string. The language C hides this extra work from us, but in assembly, we need to manage this ourselves!</p>
    
      <p>Finally, we consider the line:</p>
    <pre>  bl	printf</pre>
      <p>This line makes the actual call to the function <c>printf</c>. Which registers are used for the arguments of this function? Enter the registers (e.g., <c>r0</c>) in ascending order, separated by commas, with no spaces. <answer type="text">r0,r1</answer></p>
    
      <p>If we were going to write this program directly in assembly (rather than generating it from a C program), we would simplify the code and use more meaningful names for our strings and pointers. It would look like the following:</p>
    
    <pre>    .section .data
      a:	
        .word 4
      b:
        .word 7
    
        .section .rodata
      c:	
        .word 12
      a_str:	
        .ascii "a is %d.\012\000"
        .align 2
      b_str:	
        .ascii "b is %d.\012\000"
        .align 2
      c_str:	
        .ascii "c is %d.\012\000"
        .align 2
        
        .text
        .global main
      main:
        push	{fp, lr}
        add	fp, sp, #4
        
        ldr	r3, =a
        ldr	r1, [r3]
        ldr	r0, a_str_ptr
        bl	printf
    
        ldr	r3, =b
        ldr	r1, [r3]
        ldr	r0, b_str_ptr
        bl	printf
    
        ldr	r3, =c
        ldr	r1, [r3]
        ldr	r0, c_str_ptr
        bl	printf
        
        mov	r0, #0
        pop	{fp, pc}
        
      a_str_ptr:
        .word		a_str
      b_str_ptr:
        .word		b_str
      c_str_ptr:
        .word		c_str</pre>
    
    </section>
    
    <section><title>Writing an Assembly-Only Program</title>
    
      <p>Note: this section will be graded as part of Homework 4. If you are short of time for completing this lab, you can skip ahead to the next section and come back to this later.</p>
    
      <p>Move back to your <c>HD</c> directory, and create a subdirectory for Homework 4 with the following commands.</p>
    <pre>  cd ~/HD
      mkdir HW4
      cd HW4</pre>
    
      <p>Create a new assembly program, using the following command.</p>
    <pre>  code hello.s</pre>
    <p>Now, write an assembly program that prints the string “Hello, world!”. The program shouldn't do anything else.</p>
    
    <p>To test your assembly program, compile and run it with the following commands.</p>
    <pre>  gcc hello.s -o hello
      ./hello</pre>
    
    <p>Hints:</p>
      <ul>
    <li>Use the program from the end of the previous section to help you get started.</li>
    <li>This program will not have any global variables or constants, other than what is needed for the string to be printed.</li>
    <li>At the beginning of the function <c>main</c>, you need the lines:
    <pre>  push	{fp, lr}
      add	fp, sp, #4</pre>
    We'll cover what these do in a later lab.</li>
    <li>At the end of the function <c>main</c>, you need the lines:
    <pre>  mov	r0, #0
      pop	{fp, pc}</pre>
    The first of these sets up <c>main</c> to return 0. We'll cover what the other line does in a later lab.</li>
    <li>When you call printf, think about how many arguments you need, and set up the register(s) appropriately.</li>
      </ul>
    
    <p>To submit your work in this part: carry these steps out on your Pi.</p>
    <pre>  cd ~/HD/HW4
      git add hello.s
      git commit -m "HW4: Exercise 1 complete"
      git pull origin main
      git push origin main</pre>
    
    </section>
    
    <section><title>Assembling a C Program with <c>scanf</c></title>
    
    <p>Now, we will start to figure out how to get user input in assembly, by generating an assembly program from a C program that uses the function <c>scanf()</c>.</p>
    
    <p>In your <c>lab13</c> subdirectory on your Raspberry pi, create a C program with the following command.</p>
    <pre>  code input_example.c</pre>
    <p>Copy the following C code into <c>input_example.c</c>.</p>
    <pre>  #include &lt;stdio.h&gt;
    
      int a;
      int b;
    
      int main() {
      printf("Value for a: ");
      scanf("%d", &a);
      printf("Value for b: ");
      scanf("%d", &b);
      printf("a is %d and b is %d.\n", a, b);
      return 0;
    }</pre>
    
    <p>Save the file.</p>
    
    <p>Compile and run <c>input_example.c</c> with the following commands.</p>
    <pre>  gcc input_example.c -o input_example
      ./input_example</pre>
      <p>To produce the assembly language version of this program, enter the command</p>
    <pre>  gcc -c -S input_example.c</pre>
    
    <p>This should produce a file <c>input_example.s</c> that contains assembly code for the program <c>input_example.c</c>. Check that it's there by entering the <c>ls</c> command.</p>
    
      <p>Open your assembly program in VSCode using the command</p>
    <pre>  code input_example.s</pre>
         <p>Your assembly program should match the code below (except for the line numbers and some added indentation).</p>
    <pre>1:      .arch armv6
    2:  	.eabi_attribute 28, 1
    3:  	.eabi_attribute 20, 1
    4:  	.eabi_attribute 21, 1
    5:  	.eabi_attribute 23, 3
    6:  	.eabi_attribute 24, 1
    7:  	.eabi_attribute 25, 1
    8:  	.eabi_attribute 26, 2
    9:  	.eabi_attribute 30, 6
    10:  	.eabi_attribute 34, 1
    11:  	.eabi_attribute 18, 4
    12:  	.file		"input_example.c"
    13:  	.text
    14:  	.comm		a,4,4
    15:  	.comm		b,4,4
    16:  	.section	.rodata
    17:  	.align	2
    18:  .LC0:
    19:  	.ascii	"Value for a: \000"
    20:  	.align	2
    21:  .LC1:
    22:  	.ascii	"%d\000"
    23:  	.align	2
    24:  .LC2:
    25:  	.ascii	"Value for b: \000"
    26:  	.align	2
    27:  .LC3:
    28:  	.ascii	"a is %d and b is %d.\012\000"
    29:  	.text
    30:  	.align	2
    31:  	.global	main
    32:  	.arch armv6
    34:  	.syntax unified
    35:  	.arm
    36:  	.fpu vfp
    37:  	.type	main, %function
    38:  main:
    39:  	@ args = 0, pretend = 0, frame = 0
    40:  	@ frame_needed = 1, uses_anonymous_args = 0
    41:  	push	{fp, lr}
    42:  	add	fp, sp, #4
    43:  	ldr	r0, .L3
    44:  	bl	printf
    45:  	ldr	r1, .L3+4
    46:  	ldr	r0, .L3+8
    47:  	bl	__isoc99_scanf
    48:  	ldr	r0, .L3+12
    49:  	bl	printf
    50:  	ldr	r1, .L3+16
    51:  	ldr	r0, .L3+8
    52:  	bl	__isoc99_scanf
    53:  	ldr	r3, .L3+4
    54:  	ldr	r1, [r3]
    55:  	ldr	r3, .L3+16
    56:  	ldr	r3, [r3]
    57:  	mov	r2, r3
    58:  	ldr	r0, .L3+20
    59:  	bl	printf
    60:  	mov	r3, #0
    61:  	mov	r0, r3
    62:  	pop	{fp, pc}
    63:  .L4:
    64:  	.align	2
    65:  .L3:
    66:  	.word		.LC0
    67:  	.word		a
    68:  	.word		.LC1
    69:  	.word		.LC2
    70:  	.word		b
    71:  	.word		.LC3
    72:  	.size		main, .-main
    73:  	.ident	"GCC: (Raspbian 8.3.0-6+rpi1) 8.3.0"
    74:  	.section	.note.GNU-stack,"",%progbits</pre>
    
    <p>In this assembly program, the space for variables <c>a</c> and <c>b</c> is allocated with the following lines.</p>
    <pre>  .comm		a,4,4
      .comm		b,4,4</pre>
    <p>Note that this is different from how we've allocated space for variables previously.</p>
    
      <p>Now, let's look at the assembly code for the function call to <c>scanf</c>, which is done in the following lines.</p>
    <pre>  ldr	r1, .L3+4
      ldr	r0, .L3+8
      bl	__isoc99_scanf</pre>
    <p>Enter the line number of assembly code corresponding to .L3+4. <answer>67</answer></p>
    
      <p>Enter the line number of assembly code corresponding to .L3+8. <answer>68</answer></p>
    
      <p>Note that we are passing a <alert>pointer</alert> to the string "%d" and a <alert>pointer</alert> to the variable <c>a</c> to the function <c>scanf</c>.</p>
    
      <p>Finally, we consider the line</p>
    <pre>  bl	__isoc99_scanf</pre>
      <p>This line makes the actual call to the function <c>scanf()</c>. Which registers are used for the arguments of this function?  Enter the registers (e.g., <c>r0</c>) in ascending order, separated by commas, with no spaces. <answer type="text">r0,r1</answer></p>
    
        <p>If we were going to write this program directly in assembly (rather than generating it from a C program), we would simplify the code and use more meaningful names for our strings and pointers. It would look like the following:</p>
    
    <pre>    .section .data
      a:
        .word 0
      b:
        .word 0
      
        .section .rodata
      a_prompt:
        .ascii "Value for a: \000"
        .align 2
      b_prompt:
        .ascii "Value for b: \000"
        .align 2
      report_values:
        .ascii "a is %d and b is %d.\012\000"
        .align 2
      input:
        .ascii "%d\000"
        .align 2
    
        .text
        .global main
      main:
        push	{fp, lr}
        add	fp, sp, #4
      
        ldr	r0, a_prompt_ptr
        bl	printf
      
        ldr	r1, =a
        ldr	r0, input_ptr
        bl	scanf
      
        ldr	r0, b_prompt_ptr
        bl	printf
      
        ldr	r1, =b
        ldr	r0, input_ptr
        bl	scanf
      
        ldr	r1, =a
        ldr r1, [r1]
        ldr	r2, =b
        ldr r2, [r2]
        ldr	r0, report_values_ptr
        bl	printf
      
        mov	r0, #0
        pop	{fp, pc}
    
        .align 2
      
      a_prompt_ptr:
        .word a_prompt
      b_prompt_ptr:
        .word b_prompt
      report_values_ptr:
        .word report_values
      input_ptr:
        .word input</pre>
      
    </section>
    
    <section><title>Writing an Assembly Program with <c>scanf</c></title>
    
      <p>Note: this section will be graded as part of Homework 4.</p>
    
      <p>Move back to your <c>HW4</c> directory.</p>
    <pre>  cd ~HD/HW4</pre>
    
      <p>Create a new assembly program, using the following command.</p>
    <pre>  code age_this_year.s</pre>
      <p>Write an assembly program that does the following. You'll find it helpful to reference the assembly code at the end of the previous section. Remember to modify your program incrementally. That is, implement one step at a time, and compile and run your program to verify that it's working as expected, before moving on to the next step.</p>
      <ul>
    <li>There will be two global variables, <c>current_year</c> and <c>birth_year</c>. Initialize the values of both to be 0.</li>
    <li>At the beginning of <c>main</c>, print the prompt <c>“Enter the current year: “</c>, instructing the user to enter input.</li>
    <li>Using <c>scanf</c>, store the year entered by the user in the variable <c>current_year</c>. Note that you can pass the address of the variable <c>current_year</c> to <c>scanf</c> by loading it into register 1 using the line
    <pre>  ldr	r1, =current_year</pre>
    Although the C program in the previous section used <c>__isoc99_scanf</c>, you can simply use <c>scanf</c>.</li>
    <li>Then, print the prompt <c>“Enter your birth year: “</c>, instructing the user to enter input.</li>
    <li>Using <c>scanf</c>, store the year entered by the user in the variable <c>birth_year</c>.</li>
    <li>Then, proceed with the program as it worked previously:
    The program should print <c>“The current year is &lt;current year&gt;.”</c>, where &lt;current year&gt; is replaced with the value stored in the variable <c>current_year</c>. The string that you use should include a newline character.</li>
    <li>Next, the program should compute the age you will turn this year, temporarily storing the result in some register. You can compute this by subtracting the value of <c>birth_year</c> from the value of <c>current_year</c>.</li>
    <li>The program should then print <c>“This year I turn &lt;age&gt; years old.”</c>, where &lt;age&gt; is the age you computed in the previous step. The string that you use should include a newline character.</li>
    <li>Then, the program should add 1 to the value stored in the variable <c>current_year</c>, changing the value of this variable.</li>
    <li>Repeat the computation of the age you will turn in <c>current_year</c>, by subtracting <c>birth_year</c> from the updated <c>current_year</c>.</li>
    <li>Finally, the program should print <c>“In &lt;current year&gt;, I will turn &lt;age&gt; years old.”</c>, where &lt;current year&gt; and &lt;age&gt; are filled in with the value of the variable <c>current_year</c> and the age computed in the previous step. The string that you use should include a newline character.</li>
      </ul>
    
    <p>Verify that your program works correctly by testing it for at least five different combinations of user input for the current year and birth year.</p>
    
      <p>To submit your work in this part: carry these steps out on your Pi.</p>
    <pre>  cd ~/HD/HW4
      git add age_this_year.s
      git commit -m "HW4: Exercise 2 complete"
      git pull origin main
      git push origin main</pre>
    
    
    </section>